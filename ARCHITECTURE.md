# 🏗️ Архитектура To-Do Bot

## 📊 Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                    TELEGRAM USER                            │
│              (Пользователь в Telegram)                      │
└────────────────┬──────────────────────────────────────────┘
                 │
                 │ Сообщения & Callback'и
                 ▼
┌─────────────────────────────────────────────────────────────┐
│           TELEGRAM BOT API (Облако)                          │
│         (telegram.org servers)                              │
└────────────────┬──────────────────────────────────────────┘
                 │
                 │ python-telegram-bot library
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    BOT.PY                                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Application (Основное приложение)                     │  │
│  │                                                       │  │
│  │ ┌─────────────────────────────────────────────────┐  │  │
│  │ │ CommandHandler (/start, /help)                  │  │  │
│  │ └─────────────────────────────────────────────────┘  │  │
│  │                                                       │  │
│  │ ┌─────────────────────────────────────────────────┐  │  │
│  │ │ ConversationHandler (Добавление задачи)        │  │  │
│  │ │  ├─ WAITING_TASK_NAME                          │  │  │
│  │ │  ├─ WAITING_TIMEZONE                           │  │  │
│  │ │  └─ WAITING_REMINDER_TIME                      │  │  │
│  │ └─────────────────────────────────────────────────┘  │  │
│  │                                                       │  │
│  │ ┌─────────────────────────────────────────────────┐  │  │
│  │ │ CallbackQueryHandler (Inline кнопки)           │  │  │
│  │ │  ├─ pending_tasks                              │  │  │
│  │ │  ├─ completed_tasks                            │  │  │
│  │ │  ├─ complete_todo                              │  │  │
│  │ │  ├─ delete_todo                                │  │  │
│  │ │  └─ back_to_main                               │  │  │
│  │ └─────────────────────────────────────────────────┘  │  │
│  │                                                       │  │
│  │ ┌─────────────────────────────────────────────────┐  │  │
│  │ │ polling() - Слушание обновлений                │  │  │
│  │ └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────┬──────────────────────────────────────────┘
                 │
                 │ Запросы к базе
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                  DATABASE.PY                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ TodoDatabase (Управление данными)                    │  │
│  │                                                       │  │
│  │ add_todo()        - Добавить задачу                  │  │
│  │ get_pending_todos() - Получить активные             │  │
│  │ get_completed_todos() - Получить завершённые        │  │
│  │ complete_todo()   - Отметить как готовую            │  │
│  │ delete_todo()     - Удалить задачу                  │  │
│  │ get_user_timezone() - Получить часовой пояс         │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────┬──────────────────────────────────────────┘
                 │
                 │ Чтение/Запись JSON
                 ▼
┌─────────────────────────────────────────────────────────────┐
│              TODOS.JSON (Файловая база)                     │
│                                                              │
│ {                                                            │
│   "123456789": {                                            │
│     "timezone": "GMT+3",                                    │
│     "todos": [                                              │
│       {"id": 0, "task": "...", "completed": false, ...}    │
│     ]                                                        │
│   }                                                          │
│ }                                                            │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных: Добавление задачи

```
Пользователь нажимает "Добавить задачу"
        │
        ▼
Callback: add_task (pattern: "^add_task$")
        │
        ▼
add_task_start() функция запускается
        │
        ├─ Отправляет сообщение с просьбой названия
        │
        ▼
Пользователь пишет название задачи
        │
        ▼
MessageHandler срабатывает (filters.TEXT)
        │
        ▼
task_name_received() функция запускается
        │
        ├─ Сохраняет название в context.user_data
        ├─ Отправляет сообщение с просьбой часового пояса
        │
        ▼
Пользователь пишет часовой пояс
        │
        ▼
MessageHandler срабатывает
        │
        ▼
timezone_received() функция запускается
        │
        ├─ Валидирует часовой пояс (regex)
        ├─ Сохраняет в context.user_data
        ├─ Отправляет сообщение с просьбой времени
        │
        ▼
Пользователь пишет время
        │
        ▼
MessageHandler срабатывает
        │
        ▼
reminder_time_received() функция запускается
        │
        ├─ Валидирует время (datetime.strptime)
        ├─ Получает данные из context.user_data
        ├─ Вызывает db.add_todo()
        │   │
        │   ▼
        │   TodoDatabase.add_todo() функция
        │   │
        │   ├─ Валидирует время
        │   ├─ Создаёт объект задачи
        │   ├─ Сохраняет в data структуру
        │   ├─ Вызывает _save_data()
        │   │   │
        │   │   ▼
        │   │   Записывает в todos.json
        │   │
        │   ▼
        │   Возвращает True/False
        │
        ├─ Отправляет подтверждение пользователю
        ├─ Очищает context.user_data
        │
        ▼
ConversationHandler.END
```

## 📦 Структура данных

### User Context (Временное хранилище)
```python
context.user_data = {
    'task_name': 'Купить молоко',
    'timezone': 'GMT+3',
    'reminder_time': '09:00'
}
```

### Database Structure (Постоянное хранилище)
```json
{
  "user_id": {
    "timezone": "GMT+3",
    "todos": [
      {
        "id": 0,
        "task": "Купить молоко",
        "completed": false,
        "created_at": "2025-12-28T10:30:00.123456",
        "reminder_time": "09:00"
      },
      {
        "id": 1,
        "task": "Встреча с командой",
        "completed": true,
        "created_at": "2025-12-28T08:00:00.123456",
        "reminder_time": "14:00"
      }
    ]
  }
}
```

## 🔐 Валидация данных

```
Входные данные → Валидация → Обработка → Сохранение
                    │
                    ├─ Название: не пусто
                    ├─ Часовой пояс: Regex проверка (GMT±)
                    └─ Время: Datetime parse проверка (HH:MM)
```

## 🎯 Состояния ConversationHandler

```
                    НАЧАЛО
                      │
                      ▼
             [entry_point: add_task_start]
                      │
                      ▼
         State: WAITING_TASK_NAME
         MessageHandler → task_name_received()
                      │
                      ▼
         State: WAITING_TIMEZONE
         MessageHandler → timezone_received()
                      │
                      ▼
         State: WAITING_REMINDER_TIME
         MessageHandler → reminder_time_received()
                      │
                      ├─ Валидация успешна ───→ [DB сохранение] → ConversationHandler.END
                      │
                      └─ Валидация ошибка ──→ [Повторный запрос] → [Остаёмся в state]
                      
                      ИЛИ
                      
                      ├─ Пользователь нажал "Отмена" ──→ cancel() → ConversationHandler.END
```

## 🔗 Связь компонентов

```
┌─────────────┐
│  Telegram   │
│   API       │
└──────┬──────┘
       │
       │ requests
       ▼
┌────────────────────────┐
│  python-telegram-bot   │
│   (library)            │
└──────┬─────────────────┘
       │
       │ handlers
       ▼
┌────────────────────────┐        ┌────────────────┐
│      bot.py            │───────→│  database.py   │
│   (Обработчики)        │        │  (Логика БД)   │
└────────────────────────┘        └────────┬───────┘
                                           │
                                           ▼
                                   ┌────────────────┐
                                   │  todos.json    │
                                   │  (Данные)      │
                                   └────────────────┘
```

## 📈 Масштабируемость

### Текущая архитектура подходит для:
- ✅ Одного пользователя
- ✅ Небольшого количества задач (до тысячи)
- ✅ Локального использования

### Для увеличения масштаба нужно:
1. **Заменить JSON на настоящую БД** (SQLite, PostgreSQL)
2. **Добавить кеширование** (Redis) для частых операций
3. **Внедрить очереди** (RabbitMQ, Celery) для напоминаний
4. **Разделить на микросервисы** для большого количества пользователей
5. **Добавить обработку ошибок** и логирование

### Примерная схема расширения:
```
Текущее              Будущее
────────────────────────────────────
todos.json      →    PostgreSQL
polling()       →    Webhook
Нет напоминаний →    APScheduler + Celery
Один файл       →    Docker контейнеры
```

## 🔄 Жизненный цикл приложения

```
1. ИНИЦИАЛИЗАЦИЯ
   ├─ load_dotenv() - загрузка .env файла
   ├─ BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
   ├─ db = TodoDatabase() - инициализация БД
   └─ application = Application.builder()...

2. РЕГИСТРАЦИЯ ОБРАБОТЧИКОВ
   ├─ CommandHandler("/start", start)
   ├─ ConversationHandler (add_task)
   ├─ CallbackQueryHandler (кнопки)
   └─ MessageHandler (текстовые сообщения)

3. ЗАПУСК
   ├─ application.run_polling()
   └─ Начало слушания обновлений Telegram

4. ОБРАБОТКА СОБЫТИЙ
   ├─ Получить обновление от Telegram
   ├─ Найти соответствующий handler
   ├─ Выполнить функцию-обработчик
   ├─ Отправить ответ пользователю
   └─ Сохранить данные в БД

5. ЗАВЕРШЕНИЕ
   ├─ Ctrl+C - сигнал прерывания
   ├─ application.stop()
   └─ Закрытие соединений
```

## 🎨 Дизайн взаимодействия

```
Пользователь                              Бот
     │                                     │
     ├─ Отправляет /start ───────────────→│
     │                                     │
     │← [Главное меню с 3 кнопками] ──────┤
     │                                     │
     ├─ Нажимает кнопку ─────────────────→│
     │                                     │
     │← [Обновленное сообщение] ──────────┤
     │                                     │
     ├─ Взаимодействует с интерфейсом ───→│
     │                                     │
     │← [Обновления сообщений] ──────────┤
     │                                     │
     ├─ Нажимает "Назад" ───────────────→│
     │                                     │
     │← [Возврат в главное меню] ────────┤
     │                                     │
     └─ Повторить по необходимости ──────→│
```

## 💾 Сохранение состояния

### Постоянные данные (сохраняются)
- Все задачи и их статус
- Часовой пояс пользователя
- Метаданные (время создания, время напоминания)

### Временные данные (теряются после перезагрузки)
- Текущее состояние ConversationHandler
- context.user_data
- История сообщений в Telegram (сохраняется на серверах Telegram)

---

**Архитектура разработана для простоты и расширяемости! 🚀**
